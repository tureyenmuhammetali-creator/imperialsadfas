@model Reservation
@{
    ViewData["Title"] = "Manuel Rezervasyon Kaydı";
    Layout = "_AdminLayout";
    var vehicles = ViewBag.Vehicles as List<Vehicle> ?? new List<Vehicle>();
    var regions = ViewBag.Regions as List<Region> ?? new List<Region>();
}

<div class="admin-form-page">
    <div class="form-header d-flex justify-content-between align-items-center mb-3">
        <a asp-action="Reservations" class="btn btn-outline">
            <i class="bi bi-arrow-left"></i> Rezervasyonlara Dön
        </a>
        <span class="badge" style="background:#238636; color:#fff;">Site Dışı / Manuel Kayıt</span>
    </div>

    <div class="admin-card">
        <div class="card-body">
            <p class="text-muted mb-4">
                <i class="bi bi-info-circle"></i> Telefon, WhatsApp veya başka kanallardan alınan rezervasyonları sisteme manuel olarak ekleyebilirsiniz.
            </p>

            <form asp-action="CreateReservation" method="post" class="admin-form" id="createReservationForm">
                @Html.AntiForgeryToken()

                <input type="hidden" asp-for="PickupLocationType" value="@LocationType.Havalimani" />
                <input type="hidden" asp-for="DropoffLocationType" value="@LocationType.Otel" />

                <!-- Transfer Yönü -->
                <div class="form-group mb-4">
                    <label class="control-label">Transfer Yönü</label>
                    <div class="d-flex gap-3">
                        <label class="d-flex align-items-center gap-2">
                            <input type="radio" name="transferDirection" value="airportToHotel" checked />
                            Havalimanından Alınacak (Havalimanı → Otel)
                        </label>
                        <label class="d-flex align-items-center gap-2">
                            <input type="radio" name="transferDirection" value="hotelToAirport" />
                            Havalimanına Gidilecek (Otel → Havalimanı)
                        </label>
                    </div>
                </div>

                <!-- Bölge ve Güzergah -->
                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="RegionId">Bölge *</label>
                        <select asp-for="RegionId" class="form-control" id="regionSelect" required>
                            <option value="">— Bölge seçiniz —</option>
                            @foreach (var r in regions)
                            {
                                <option value="@r.Id" data-start="@r.StartPoint" data-name="@r.Name" data-price="@r.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)">@r.Name — @r.Price.ToString("N0") €</option>
                            }
                        </select>
                        <span asp-validation-for="RegionId" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="PickupLocation">Alınacak Nokta *</label>
                        <input asp-for="PickupLocation" class="form-control" id="pickupLocation" placeholder="Bölge seçince dolacak" required />
                        <span asp-validation-for="PickupLocation" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="DropoffLocation">Bırakılacak Nokta *</label>
                        <input asp-for="DropoffLocation" class="form-control" id="dropoffLocation" placeholder="Bölge seçince dolacak" required />
                        <span asp-validation-for="DropoffLocation" class="text-danger"></span>
                    </div>
                </div>

                <!-- Araç -->
                <div class="form-group">
                    <label asp-for="VehicleId">Araç *</label>
                    <select asp-for="VehicleId" class="form-control" id="vehicleSelect" required>
                        <option value="">— Araç seçiniz —</option>
                        @foreach (var v in vehicles)
                        {
                            <option value="@v.Id" data-min-eur="@v.MinimumPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)">@v.Name — @v.MinimumPrice.ToString("N0") €</option>
                        }
                    </select>
                    <span asp-validation-for="VehicleId" class="text-danger"></span>
                </div>

                <!-- Tarih ve Saat -->
                <div class="form-group">
                    <label>Transfer Tarih ve Saati *</label>
                    <div class="datetime-row">
                        <div class="datetime-input-wrap">
                            <span class="dt-icon"><i class="bi bi-calendar3"></i></span>
                            <input asp-for="TransferDate" type="date" class="form-control" required id="transferDate" />
                        </div>
                        <div class="datetime-input-wrap">
                            <span class="dt-icon"><i class="bi bi-clock"></i></span>
                            <input asp-for="TransferTime" type="time" class="form-control" required id="transferTime" />
                        </div>
                    </div>
                    <span asp-validation-for="TransferDate" class="text-danger"></span>
                    <span asp-validation-for="TransferTime" class="text-danger"></span>
                </div>

                <!-- Otel, Uçuş -->
                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="HotelName">Otel Adı</label>
                        <input asp-for="HotelName" class="form-control" placeholder="Otel adı" maxlength="200" />
                    </div>
                    <div class="form-group">
                        <label asp-for="FlightNumber">Uçuş Numarası</label>
                        <input asp-for="FlightNumber" class="form-control" placeholder="Örn: TK1234" maxlength="20" />
                    </div>
                    <div class="form-group">
                        <label asp-for="AirlineCompany">Havayolu</label>
                        <input asp-for="AirlineCompany" class="form-control" placeholder="Havayolu şirketi" maxlength="100" />
                    </div>
                </div>

                <!-- Dönüş Transferi -->
                <div class="form-group">
                    <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" name="IsReturnTransfer" value="true" id="isReturnTransfer" />
                        Dönüş transferi var
                    </label>
                </div>

                <div id="returnFields" style="display:none;">
                    <div class="form-group">
                        <label>Dönüş Tarih ve Saati</label>
                        <div class="datetime-row">
                            <div class="datetime-input-wrap">
                                <span class="dt-icon"><i class="bi bi-calendar3"></i></span>
                                <input asp-for="ReturnTransferDate" type="date" class="form-control" />
                            </div>
                            <div class="datetime-input-wrap">
                                <span class="dt-icon"><i class="bi bi-clock"></i></span>
                                <input asp-for="ReturnTransferTime" type="time" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="ReturnFlightNumber">Dönüş Uçuş Numarası</label>
                        <input asp-for="ReturnFlightNumber" class="form-control" placeholder="Örn: TK5678" maxlength="20" />
                    </div>
                </div>

                <!-- Yolcu Bilgileri -->
                <h5 class="mt-4 mb-2">Yolcu Bilgileri</h5>
                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="NumberOfAdults">Yetişkin Sayısı</label>
                        <input asp-for="NumberOfAdults" type="number" class="form-control" min="1" max="20" value="1" id="numberOfAdults" />
                    </div>
                    <div class="form-group">
                        <label asp-for="NumberOfChildren">Çocuk Sayısı</label>
                        <input asp-for="NumberOfChildren" type="number" class="form-control" min="0" max="20" value="0" id="numberOfChildren" />
                    </div>
                    <div class="form-group">
                        <label asp-for="ChildSeatCount">Çocuk Koltuğu</label>
                        <input asp-for="ChildSeatCount" type="number" class="form-control" min="0" max="10" value="0" />
                    </div>
                </div>
                <input type="hidden" asp-for="PassengerCount" id="passengerCountHidden" value="1" />

                <!-- 1. Yolcu (Ana müşteri) - Yukarıda -->
                <h5 class="mt-4 mb-2">Müşteri Bilgileri (1. Yolcu)</h5>
                <p class="form-hint mb-2 text-muted">Ana iletişim bilgileri.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="CustomerName">Ad Soyad *</label>
                        <input asp-for="CustomerName" class="form-control" placeholder="Ad Soyad" required />
                        <span asp-validation-for="CustomerName" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="CustomerPhone">Telefon *</label>
                        <input asp-for="CustomerPhone" type="tel" class="form-control" placeholder="+90 5XX XXX XX XX" required maxlength="30" />
                        <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="CustomerEmail">E-posta</label>
                        <input asp-for="CustomerEmail" type="email" class="form-control" placeholder="ornek@email.com" />
                    </div>
                </div>

                <!-- 2. Yolcu, 3. Yetişkin, 1. Çocuk, 2. Çocuk - Aşağıda -->
                <div class="form-group mt-4" id="additionalPassengersGroup" style="display:none;">
                    <label class="control-label">2. yetişkin, 3. yetişkin... / 1. çocuk, 2. çocuk... (sadece Ad Soyad)</label>
                    <div id="additionalPassengerInputs"></div>
                    <input type="hidden" name="AdditionalPassengerNames" id="additionalPassengerNamesHidden" />
                    <input type="hidden" name="ChildNames" id="childNamesHidden" />
                </div>

                <!-- Ücretlendirme -->
                <h5 class="mt-4 mb-2">Ücretlendirme</h5>

                <div id="autoPriceSection">
                    <div class="d-flex align-items-center gap-3 mb-3" style="flex-wrap:wrap;">
                        <div style="flex:1; min-width:200px;">
                            <label class="control-label" style="margin-bottom:4px; font-size:0.85em; color:#aaa;">Hesaplanan Fiyat (Bölge + Araç)</label>
                            <div id="calculatedPriceDisplay" style="font-size:1.5em; font-weight:700; color:#d4af37; letter-spacing:1px;">
                                — €
                            </div>
                            <div id="priceBreakdown" style="font-size:0.82em; color:#888; margin-top:2px;"></div>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline" id="toggleManualPriceBtn" style="white-space:nowrap;">
                                <i class="bi bi-pencil-square"></i> Manuel Fiyatlandırma
                            </button>
                        </div>
                    </div>
                    <input type="hidden" asp-for="EstimatedPrice" id="estimatedPriceHidden" />
                </div>

                <div id="manualPriceSection" style="display:none;">
                    <div class="d-flex align-items-end gap-3 mb-2" style="flex-wrap:wrap;">
                        <div class="form-group" style="flex:1; min-width:200px; margin-bottom:0;">
                            <label asp-for="EstimatedPrice">Manuel Fiyat (€)</label>
                            <input type="number" step="0.01" class="form-control" min="0" placeholder="0.00" id="manualPriceInput" />
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline" id="toggleAutoPriceBtn" style="white-space:nowrap;">
                                <i class="bi bi-calculator"></i> Otomatik Fiyata Dön
                            </button>
                        </div>
                    </div>
                    <small class="form-hint" style="color:#d4af37;">Otomatik hesaplanan fiyat yerine kendiniz fiyat belirleyebilirsiniz.</small>
                </div>

                <!-- Dil Seçimi -->
                <div class="form-group">
                    <label asp-for="Language">Müşteri Dili</label>
                    <select asp-for="Language" class="form-control" style="max-width: 220px;">
                        <option value="tr">Türkçe</option>
                        <option value="en" selected>English</option>
                        <option value="de">Deutsch</option>
                        <option value="ru">Русский</option>
                    </select>
                    <small class="form-hint">Müşteriye mail ve PDF bu dilde gönderilir</small>
                </div>

                <!-- Notlar ve Durum -->
                <div class="form-row">
                    <div class="form-group">
                        <label asp-for="Notes">Müşteri Notları</label>
                        <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Müşterinin özel istekleri"></textarea>
                    </div>
                    <div class="form-group">
                        <label asp-for="AdminNotes">Admin Notu</label>
                        <textarea asp-for="AdminNotes" class="form-control" rows="2" placeholder="İç not (müşteriye görünmez)"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Status">Rezervasyon Durumu</label>
                    <select asp-for="Status" class="form-control">
                        <option value="@ReservationStatus.Beklemede">Beklemede</option>
                        <option value="@ReservationStatus.Onaylandi" selected>Onaylandı</option>
                        <option value="@ReservationStatus.Tamamlandi">Tamamlandı</option>
                        <option value="@ReservationStatus.IptalEdildi">İptal Edildi</option>
                    </select>
                    <small class="form-hint">Manuel kayıtlarda genelde "Onaylandı" seçilir (telefonla teyit edilmiş)</small>
                </div>

                <hr class="my-4" />
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> Rezervasyonu Kaydet
                    </button>
                    <a asp-action="Reservations" class="btn btn-outline">İptal</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    var regionSelect = document.getElementById('regionSelect');
    var pickupInput = document.getElementById('pickupLocation');
    var dropoffInput = document.getElementById('dropoffLocation');
    var dirAirport = document.querySelector('input[name="transferDirection"][value="airportToHotel"]');
    var dirHotel = document.querySelector('input[name="transferDirection"][value="hotelToAirport"]');
    var isReturn = document.getElementById('isReturnTransfer');
    var returnFields = document.getElementById('returnFields');

    function applyDirection() {
        var opt = regionSelect && regionSelect.options[regionSelect.selectedIndex];
        if (!opt || !opt.value) return;
        var start = opt.getAttribute('data-start') || '';
        var name = opt.getAttribute('data-name') || '';
        var isAirportToHotel = dirAirport && dirAirport.checked;
        if (isAirportToHotel) {
            if (pickupInput) pickupInput.value = start;
            if (dropoffInput) dropoffInput.value = name;
        } else {
            if (pickupInput) pickupInput.value = name;
            if (dropoffInput) dropoffInput.value = start;
        }
    }

    if (dirAirport) dirAirport.addEventListener('change', function() { applyDirection(); calculatePrice(); });
    if (dirHotel) dirHotel.addEventListener('change', function() { applyDirection(); calculatePrice(); });

    if (isReturn && returnFields) {
        isReturn.addEventListener('change', function() {
            returnFields.style.display = this.checked ? 'block' : 'none';
        });
        returnFields.style.display = isReturn.checked ? 'block' : 'none';
    }

    // Yolcu sayısı mantığı - sitedeki ile aynı: 2. Yetişkin, 3. Yetişkin... / 1. Çocuk, 2. Çocuk...
    function renderAdditionalPassengerInputs() {
        var adults = parseInt(document.getElementById('numberOfAdults')?.value || document.querySelector('input[name="NumberOfAdults"]')?.value, 10) || 1;
        var children = parseInt(document.getElementById('numberOfChildren')?.value || document.querySelector('input[name="NumberOfChildren"]')?.value, 10) || 0;
        var total = adults + children;
        var container = document.getElementById('additionalPassengerInputs');
        var group = document.getElementById('additionalPassengersGroup');
        var hiddenCount = document.getElementById('passengerCountHidden');
        if (!container || !group) return;
        container.innerHTML = '';
        var idx = 0;
        for (var i = 0; i < adults - 1; i++) {
            var label = document.createElement('label');
            label.className = 'control-label';
            label.textContent = (i + 2) + '. Yetişkin';
            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = 'Ad Soyad';
            input.name = 'additionalPassenger_' + (++idx);
            input.setAttribute('data-type', 'adult');
            var div = document.createElement('div');
            div.className = 'form-group form-group-sm';
            div.style.marginBottom = '12px';
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        }
        if (children > 0) {
            var sep = document.createElement('hr');
            sep.style.margin = '16px 0 8px 0';
            sep.style.borderColor = '#d4af37';
            container.appendChild(sep);
        }
        for (var j = 0; j < children; j++) {
            var label = document.createElement('label');
            label.className = 'control-label';
            label.textContent = (j + 1) + '. Çocuk';
            var input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = 'Ad Soyad';
            input.name = 'childPassenger_' + (j + 1);
            input.setAttribute('data-type', 'child');
            var div = document.createElement('div');
            div.className = 'form-group form-group-sm';
            div.style.marginBottom = '12px';
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        }
        group.style.display = (adults > 1 || children > 0) ? 'block' : 'none';
        if (hiddenCount) hiddenCount.value = total.toString();
    }
    function collectAdditionalPassengerNames() {
        var adultInputs = document.querySelectorAll('#additionalPassengerInputs input[data-type="adult"]');
        var childInputs = document.querySelectorAll('#additionalPassengerInputs input[data-type="child"]');
        var adultNames = [], childNames = [];
        adultInputs.forEach(function(inp) { var v = (inp.value||'').trim(); if (v) adultNames.push(v); });
        childInputs.forEach(function(inp) { var v = (inp.value||'').trim(); if (v) childNames.push(v); });
        var hidden = document.getElementById('additionalPassengerNamesHidden');
        if (hidden) hidden.value = adultNames.join('; ');
        var childHidden = document.getElementById('childNamesHidden');
        if (childHidden) childHidden.value = childNames.join('; ');
    }
    var adultsInput = document.getElementById('numberOfAdults') || document.querySelector('input[name="NumberOfAdults"]');
    var childrenInput = document.getElementById('numberOfChildren') || document.querySelector('input[name="NumberOfChildren"]');
    if (adultsInput) { adultsInput.addEventListener('change', renderAdditionalPassengerInputs); adultsInput.addEventListener('input', renderAdditionalPassengerInputs); }
    if (childrenInput) { childrenInput.addEventListener('change', renderAdditionalPassengerInputs); childrenInput.addEventListener('input', renderAdditionalPassengerInputs); }
    renderAdditionalPassengerInputs();

    var form = document.getElementById('createReservationForm');
    if (form) {
        form.addEventListener('submit', function() {
            var adults = parseInt(adultsInput?.value || '1', 10) || 1;
            var children = parseInt(childrenInput?.value || '0', 10) || 0;
            var pc = document.getElementById('passengerCountHidden');
            if (pc) pc.value = (adults + children).toString();
            collectAdditionalPassengerNames();
        });
    }

    // --- Fiyat Hesaplama ---
    var vehicleSelect = document.getElementById('vehicleSelect');
    var estimatedPriceHidden = document.getElementById('estimatedPriceHidden');
    var calculatedPriceDisplay = document.getElementById('calculatedPriceDisplay');
    var priceBreakdown = document.getElementById('priceBreakdown');
    var manualPriceInput = document.getElementById('manualPriceInput');
    var autoPriceSection = document.getElementById('autoPriceSection');
    var manualPriceSection = document.getElementById('manualPriceSection');
    var toggleManualBtn = document.getElementById('toggleManualPriceBtn');
    var toggleAutoBtn = document.getElementById('toggleAutoPriceBtn');
    var isManualPricing = false;

    function calculatePrice() {
        if (isManualPricing) return;
        var regionOpt = regionSelect && regionSelect.options[regionSelect.selectedIndex];
        var vehicleOpt = vehicleSelect && vehicleSelect.options[vehicleSelect.selectedIndex];
        var regionPrice = (regionOpt && regionOpt.value) ? parseFloat(regionOpt.getAttribute('data-price') || '0') : 0;
        var vehiclePrice = (vehicleOpt && vehicleOpt.value) ? parseFloat(vehicleOpt.getAttribute('data-min-eur') || '0') : 0;
        var total = regionPrice + vehiclePrice;

        if (total > 0) {
            calculatedPriceDisplay.textContent = total.toFixed(2).replace('.', ',') + ' €';
            var parts = [];
            if (regionPrice > 0) parts.push('Bölge: ' + regionPrice.toFixed(0) + ' €');
            if (vehiclePrice > 0) parts.push('Araç: ' + vehiclePrice.toFixed(0) + ' €');
            priceBreakdown.textContent = parts.join(' + ');
        } else {
            calculatedPriceDisplay.textContent = '— €';
            priceBreakdown.textContent = 'Bölge ve araç seçilince fiyat otomatik hesaplanır';
        }
        estimatedPriceHidden.value = total > 0 ? total.toFixed(2) : '';
    }

    if (toggleManualBtn) {
        toggleManualBtn.addEventListener('click', function() {
            isManualPricing = true;
            autoPriceSection.style.display = 'none';
            manualPriceSection.style.display = 'block';
            manualPriceInput.value = estimatedPriceHidden.value || '';
            manualPriceInput.focus();
        });
    }
    if (toggleAutoBtn) {
        toggleAutoBtn.addEventListener('click', function() {
            isManualPricing = false;
            manualPriceSection.style.display = 'none';
            autoPriceSection.style.display = 'block';
            calculatePrice();
        });
    }
    if (manualPriceInput) {
        manualPriceInput.addEventListener('input', function() {
            estimatedPriceHidden.value = this.value || '';
        });
    }

    if (regionSelect) regionSelect.addEventListener('change', function() { applyDirection(); calculatePrice(); });
    if (vehicleSelect) vehicleSelect.addEventListener('change', calculatePrice);

    // Sayfa yüklendiğinde bölge seçiliyse güncelle
    if (regionSelect && regionSelect.value) applyDirection();
    calculatePrice();
});
</script>
}
