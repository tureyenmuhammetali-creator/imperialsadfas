@model IEnumerable<Vehicle>
@{
    ViewData["Title"] = "Araçlarımız";
    var currentLang = ViewContext.RouteData.Values["lang"]?.ToString() ?? "tr";
    var t = new Dictionary<string, string> {
        ["tr"] = "Lütfen araç seçiniz",
        ["de"] = "Bitte wählen Sie ein Fahrzeug",
        ["ru"] = "Пожалуйста, выберите автомобиль",
        ["en"] = "Please select a vehicle"
    };
    var pleaseSelectVehicle = t.ContainsKey(currentLang) ? t[currentLang] : t["tr"];
}

<!-- Page Header -->
<section class="page-header">
    <div class="container">
        <h1>Araçlarımız</h1>
        <nav class="breadcrumb">
            <a asp-controller="Home" asp-action="Index" asp-route-lang="@currentLang">Ana Sayfa</a>
            <span>/</span>
            <span>Araçlarımız</span>
        </nav>
    </div>
</section>

<!-- Vehicles Intro -->
<section class="vehicles-intro section" style="content-visibility: auto;">
    <div class="container">
        <div class="section-header">
            <span class="section-subtitle">VIP Filo</span>
            <h2 class="section-title">Lüks Araç Filomuz</h2>
            <p class="section-description">
                Imperial VIP olarak, seyahatlerinizi ayrıcalıklı kılacak üst segment araçlarla hizmet veriyoruz. 
                Tüm araçlarımız düzenli bakımdan geçer ve maksimum konfor sunar.
            </p>
        </div>
    </div>
</section>

<!-- Vehicles Grid -->
<section class="vehicles-list section" style="content-visibility: auto;">
    <div class="container">
        <div class="alert alert-info vehicle-select-hint mb-4" role="alert">
            <i class="bi bi-info-circle-fill vehicle-select-hint-icon"></i>
            <span class="vehicle-select-hint-text">@pleaseSelectVehicle</span>
        </div>
        <div class="vehicles-full-grid">
            @foreach (var vehicle in Model)
            {
                var validAlbumImages = (vehicle.Images != null ? vehicle.Images.Where(i => !string.IsNullOrWhiteSpace(i?.ImageUrl)) : Enumerable.Empty<VehicleImage>()).OrderBy(i => i.SortOrder).ToList();
                var mainImageUrl = validAlbumImages.FirstOrDefault()?.ImageUrl ?? (!string.IsNullOrWhiteSpace(vehicle.ImageUrl) ? vehicle.ImageUrl : "/images/imgs/no-image.jpg");
                var thumbUrls = validAlbumImages.Select(i => i.ImageUrl).ToList();
                var showThumbs = thumbUrls.Count > 0;
                var isPlateBlur = vehicle.Name != null && vehicle.Name.IndexOf("VIP", StringComparison.OrdinalIgnoreCase) >= 0 && vehicle.Name.Contains("2") && vehicle.Name.IndexOf("Sedan", StringComparison.OrdinalIgnoreCase) >= 0;
                <div class="vehicle-card-full @(isPlateBlur ? "plate-blur" : "")">
                    <div class="vehicle-album vehicle-slider-wrap">
                        <div class="vehicle-slider">
                            <div class="vehicle-slider-track" data-index="0">
                                @{ var slideIdx = 0; }
                                @foreach (var url in thumbUrls.Count > 0 ? thumbUrls : new List<string> { mainImageUrl })
                                {
                                    <div class="vehicle-slide @(slideIdx == 0 ? "active" : "")">
                                        <img src="@url" alt="@vehicle.Name" loading="lazy" decoding="async" onerror="this.src='/images/imgs/no-image.jpg'" />
                                    </div>
                                    slideIdx++;
                                }
                            </div>
                            @if (thumbUrls.Count > 1)
                            {
                                <button type="button" class="slider-btn slider-prev" aria-label="Önceki"><i class="bi bi-chevron-left"></i></button>
                                <button type="button" class="slider-btn slider-next" aria-label="Sonraki"><i class="bi bi-chevron-right"></i></button>
                                <div class="slider-dots">
                                    @for (int d = 0; d < thumbUrls.Count; d++)
                                    {
                                        <span class="slider-dot @(d == 0 ? "active" : "")" data-slide="@d"></span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    <div class="vehicle-details">
                        <div class="vehicle-header">
                            <h3>@vehicle.Name</h3>
                        </div>
                        
                        <p class="vehicle-description">@vehicle.Description</p>
                        
                        <div class="vehicle-specs-grid">
                            <div class="spec-item">
                                <i class="bi bi-people"></i>
                                <span>Yolcu: Min 1 – Maks @vehicle.PassengerCapacity</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(vehicle.Features))
                        {
                            <div class="vehicle-features">
                                @foreach (var feature in vehicle.Features.Split(','))
                                {
                                    <span class="feature-tag">
                                        <i class="bi bi-check"></i>
                                        @feature.Trim()
                                    </span>
                                }
                            </div>
                        }
                    </div>
                    <div class="vehicle-price-block">
                        <div class="vehicle-price-main">
                            @{
                                var hasPrice = vehicle.MinimumPrice > 0 || vehicle.MinimumPriceUsd > 0 || vehicle.MinimumPriceTry > 0;
                            }
                            @if (hasPrice)
                            {
                                <span class="vehicle-price-value"
                                      data-amount-eur="@vehicle.MinimumPrice.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                      data-amount-usd="@vehicle.MinimumPriceUsd.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                      data-amount-try="@vehicle.MinimumPriceTry.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)">
                                    @vehicle.MinimumPrice.ToString("N2", System.Globalization.CultureInfo.GetCultureInfo("tr-TR")) <span class="vehicle-currency-symbol">€</span>
                                </span>
                            }
                            else
                            {
                                <span class="vehicle-price-no-price">Fiyat için iletişime geçin</span>
                            }
                        </div>
                        <div class="vehicle-actions">
                            <a asp-controller="Reservation" asp-action="Index" asp-route-lang="@currentLang" asp-route-vehicleId="@vehicle.Id" class="btn btn-primary btn-select-vehicle">
                                <i class="bi bi-calendar-check"></i>
                                Rezervasyon Yap
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<!-- Vehicle Info -->
<section class="vehicle-info section" style="content-visibility: auto;">
    <div class="container">
        <div class="info-grid">
            <div class="info-card">
                <div class="info-icon">
                    <i class="bi bi-tools"></i>
                </div>
                <h4>Düzenli Bakım</h4>
                <p>Tüm araçlarımız düzenli periyodik bakımdan geçer. Güvenliğiniz bizim için önceliklidir.</p>
            </div>
            <div class="info-card">
                <div class="info-icon">
                    <i class="bi bi-droplet"></i>
                </div>
                <h4>Hijyen</h4>
                <p>Her transfer öncesi araçlarımız detaylı şekilde temizlenir ve dezenfekte edilir.</p>
            </div>
            <div class="info-card">
                <div class="info-icon">
                    <i class="bi bi-snow"></i>
                </div>
                <h4>Klima</h4>
                <p>Tüm araçlarımızda çift bölgeli otomatik klima sistemi bulunmaktadır.</p>
            </div>
            <div class="info-card">
                <div class="info-icon">
                    <i class="bi bi-wifi"></i>
                </div>
                <h4>WiFi & Şarj</h4>
                <p>Yolculuğunuz boyunca WiFi ve USB şarj imkanı sunuyoruz.</p>
            </div>
        </div>
    </div>
</section>

<!-- CTA -->
<section class="cta section" style="content-visibility: auto;">
    <div class="container">
        <div class="cta-content">
            <h2>Aracınızı Seçin, Rezervasyon Yapın</h2>
            <p>VIP transfer deneyimi için hemen rezervasyon oluşturun.</p>
            <a asp-controller="Reservation" asp-action="Index" asp-route-lang="@currentLang" class="btn btn-primary btn-lg">
                <i class="bi bi-calendar-check"></i>
                Rezervasyon Yap
            </a>
        </div>
    </div>
</section>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateVehiclePrices() {
        var cur = window.getImperialCurrency ? window.getImperialCurrency() : { symbol: '€', code: 'EUR' };
        var code = (cur.code || 'EUR').toUpperCase();
        document.querySelectorAll('.vehicle-price-value').forEach(function(el) {
            var amount = parseFloat(el.getAttribute('data-amount-' + code));
            if (isNaN(amount) || amount <= 0) {
                var eur = parseFloat(el.getAttribute('data-amount-eur'));
                if (!isNaN(eur) && eur > 0 && window.convertFromEur) amount = window.convertFromEur(eur);
                else if (isNaN(amount) || amount <= 0) amount = eur || 0;
            }
            var formatted = (typeof amount === 'number' ? amount : 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (el.childNodes.length && el.childNodes[0].nodeType === 3) el.childNodes[0].textContent = formatted + ' ';
            var symSpan = el.querySelector('.vehicle-currency-symbol');
            if (symSpan) symSpan.textContent = cur.symbol;
        });
    }
    updateVehiclePrices();
    window.addEventListener('imperialCurrencyChanged', updateVehiclePrices);
    window.addEventListener('imperialCurrencyRatesReady', updateVehiclePrices);

    document.querySelectorAll('.vehicle-slider-wrap').forEach(function(wrap) {
        var track = wrap.querySelector('.vehicle-slider-track');
        var slides = wrap.querySelectorAll('.vehicle-slide');
        var dots = wrap.querySelectorAll('.slider-dot');
        var prevBtn = wrap.querySelector('.slider-prev');
        var nextBtn = wrap.querySelector('.slider-next');
        if (!track || slides.length <= 1) return;
        var current = 0;
        function goTo(idx) {
            if (idx < 0) idx = slides.length - 1;
            if (idx >= slides.length) idx = 0;
            slides.forEach(function(s) { s.classList.remove('active'); });
            dots.forEach(function(d) { d.classList.remove('active'); });
            slides[idx].classList.add('active');
            if (dots[idx]) dots[idx].classList.add('active');
            current = idx;
        }
        if (prevBtn) prevBtn.addEventListener('click', function() { goTo(current - 1); });
        if (nextBtn) nextBtn.addEventListener('click', function() { goTo(current + 1); });
        dots.forEach(function(dot) {
            dot.addEventListener('click', function() { goTo(parseInt(this.getAttribute('data-slide'))); });
        });
        var startX = 0;
        track.addEventListener('touchstart', function(e) { startX = e.touches[0].clientX; }, { passive: true });
        track.addEventListener('touchend', function(e) {
            var diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 40) { diff > 0 ? goTo(current + 1) : goTo(current - 1); }
        }, { passive: true });

        var autoPlay = setInterval(function() { goTo(current + 1); }, 3000);
        wrap.addEventListener('mouseenter', function() { clearInterval(autoPlay); });
        wrap.addEventListener('mouseleave', function() {
            autoPlay = setInterval(function() { goTo(current + 1); }, 3000);
        });
    });
});
</script>
}
